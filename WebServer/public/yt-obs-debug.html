<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>OBS Chat Overlay</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

:root {
  --bg: rgba(20,20,20,0.9);
  --radius: 10px;
  --blur: blur(10px);
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  background: transparent;
  font-family: 'Inter', sans-serif;
  color: white;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ===== FIXED PLAYER SECTION ===== */
#player-section {
  flex-shrink: 0;
  width: 100%;
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(5px);
  box-shadow: 1px 10px 10px rgba(0,0,0,0.8);
}

/* ===== CHAT SECTION ===== */
#log {
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 10px;
  overflow-y: auto; /* –ò–∑–º–µ–Ω–µ–Ω–æ —Å hidden –Ω–∞ auto */
  overflow-x: hidden;
  margin-top: 0;
}

/* ===== Message card ===== */
.msg {
  will-change: transform, opacity; /* –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º –±—Ä–∞—É–∑–µ—Ä –æ–± –∞–Ω–∏–º–∞—Ü–∏—è—Ö */
  contain: content; /* –ò–∑–æ–ª–∏—Ä—É–µ–º –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ */
  display: flex;
  align-items: flex-start;
  gap: 8px;
  background: var(--bg);
  backdrop-filter: var(--blur);
  padding: 6px 10px;
  animation: slideFade 0.35s ease-out forwards;
  opacity: 0;
  transform: translateY(6px);
}

@keyframes slideFade {
  to {
    opacity: 1;
    transform: translateY(0);
    transform: translate3d(0, 0, 0); /* –î–ª—è –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–≥–æ —É—Å–∫–æ—Ä–µ–Ω–∏—è */
  }
}

/* ===== Platform icons ===== */
.icon {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
  margin-top: 2px;
}

.tiktok .icon { color: #69C9D0; }
.youtube .icon { color: #FF4444; }
.twitch .icon  { color: #9146FF; }
.telegram .icon { color: #2AABEE; }

.error {
  background: rgba(151, 31, 31, 0.8);
  border-left: 5px solid #a10a0a;
}

/* ===== Text ===== */
.content {
  display: flex;
  flex-direction: column;
  gap: 2px;
  width: 100%;
}

.nick {
  font-weight: 600;
  font-size: 20px;
  opacity: 0.95;
}

.text {
  font-size: 20px;
  line-height: 1.3;
  opacity: 0.9;
}

.time {
  font-size: 18px;
  opacity: 0.6;
  margin-right: 6px;
  white-space: nowrap;
  float: right;
}

.gift {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-right: 5px;
  padding-right: 5px;
  border-right: 1px dashed #aaa;
  text-shadow: -1px -1px 1px #000;
  vertical-align: bottom;
}

.gift img {
  width: 24px;
  height: 24px;
  border-radius: 4px;
  object-fit: cover;
}

.gift-name {
  font-weight: 600;
  color: #ffd700;
}

/* ===== Current track ===== */
#current-track {
  border-left: 30px solid #FFD700; /* –∑–æ–ª–æ—Ç–æ–π –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞ */
  font-size: 20px;
  pointer-events: none; /* –Ω–µ–ª—å–∑—è –≤—ã–¥–µ–ª—è—Ç—å */
}
#current-track .nick {
  font-weight: 700;
  font-size: 20px;
  color: #fff;
}
#current-track .text {
  font-size: 18px;
  color: #fff;
}

/* ===== –ü–ª–µ–µ—Ä –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä ===== */
.player-section {
  margin-top: 4px;
  width: 100%;
  display: none;
}

.progress-container {
  width: 100%;
  height: 4px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 2px;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #FF5555, #FFD700);
  width: 0%;
  border-radius: 4px;
  transition: width 0.3s ease;
}

.time-info {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  color: #ddd;
  margin-bottom: 2px;
}

.current-time, .total-time {
  font-weight: 600;
}

.remaining-time {
  font-size: 13px;
  color: #ffd700;
  font-weight: 600;
  text-align: center;
  background: rgba(255, 215, 0, 0.1);
  padding: 1px 6px;
  border-radius: 3px;
  margin-top: 4px;
}

/* ===== Queue section ===== */
#queue-section {
  border-top: 1px solid #333;
  width: 100%;
}

.queue-item {
  border-left: 3px solid #5599FF;
  border-bottom: 2px solid #222;
}

.queue-item .content {
  width: 100%;
}

.queue-item .nick {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 18px;
}

.queue-item .text {
  font-size: 18px;
  margin-top: 2px;
  opacity: 0.9;
}

/* ===== –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏ ===== */
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

.remaining-time.low-time {
  animation: pulse 1s infinite;
  background: rgba(255, 80, 80, 0.2);
  color: #ff8080;
}

/* –°—Ç–∏–ª—å –¥–ª—è –∑–∞–∫–∞–∑—á–∏–∫–∞ –≤ —Ç–µ–∫—É—â–µ–º —Ç—Ä–µ–∫–µ */
.requester {
  font-size: 18px;
  color: #69C9D0;
  margin-top: 4px;
  font-weight: 600;
  display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
}

/* –°—Ç–∏–ª—å –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
.compact-mode {
  min-height: auto;
  padding: 8px 10px;
}

.compact-mode .text {
  font-size: 20px;
  margin: 0;
}

/* ===== Scrollbar styling ===== */
#log::-webkit-scrollbar {
  width: 6px;
}

#log::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 3px;
}

#log::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.3);
  border-radius: 3px;
}

#log::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.5);
}

.gift-message {
  border-left: 10px solid #e37c0d;
  background: rgba(117, 52, 5, 0.8);
}

.msg.tiktok.follow {
  border-left: 10px solid #03AC03;
  background: rgba(20, 50, 20, 0.8);
}

.msg[data-user-id="system"] {
  border-left: 5px solid #cf79ff;
  background: rgba(48, 26, 98, 0.8);
}

.share {
  border-left: 5px solid #ddbc3c;
  background: rgba(74, 74, 5, 0.8);
}

.discord .icon { color: #5865F2; } /* —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π Discord blue */

.msg.discord {
  border-left: 5px solid #5865F2;
  background: rgba(40, 43, 48, 0.9);
}

/* ===== GIFT COMBO ANIMATIONS ===== */

.gift {
  transition: transform 0.2s ease;
}

.gift.pulse {
  transform: scale(1.25);
}

.gift.finish {
  animation: gift-finish 0.6s ease forwards;
}

@keyframes gift-finish {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  70% {
    transform: scale(1.4);
    opacity: 1;
  }
  100% {
    transform: scale(1.6);
    opacity: 0;
  }
}

/* –£—Å–∏–ª–µ–Ω–∏–µ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –∫–æ–º–±–æ */
.gift.big {
  color: #ffd700;
  text-shadow: 0 0 10px gold;
}

.gift.combo-done {
  transform: scale(1);
  color: #ffd700;
  transition: transform 0.3s ease, color 0.3s ease;
}
/* ===== –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–º–æ–¥–µ—Ä–∞—Ü–∏–∏ ===== */
.msg.moderation-pending {
  border-left: 5px solid #FFA500; /* –æ—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è */
  background: rgba(60, 40, 20, 0.8);
}

.msg.moderation-approved {
  border-left: 5px solid #00FF00; /* –∑–µ–ª—ë–Ω—ã–π –¥–ª—è –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö */
  background: rgba(20, 40, 20, 0.8);
  /* –ü—Ä–æ—Å—Ç–∞—è –ø–ª–∞–≤–Ω–∞—è —Å–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞ –±–µ–∑ transform */
  transition: background-color 0.3s ease, border-left-color 0.3s ease;
}

@keyframes approved-fade {
  0% { opacity: 0.7; transform: translateX(-10px); }
  100% { opacity: 1; transform: translateX(0); }
}

.msg.moderation-rejected {
  border-left: 5px solid #FF0000; /* –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –æ—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã—Ö */
  background: rgba(40, 20, 20, 0.8);
  /* –ü—Ä–æ—Å—Ç–∞—è –ø–ª–∞–≤–Ω–∞—è —Å–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞ –±–µ–∑ transform */
  transition: background-color 0.3s ease, border-left-color 0.3s ease;
}

@keyframes rejected-fade {
  0% { opacity: 0.7; transform: translateX(-10px); }
  100% { opacity: 1; transform: translateX(0); }
}

/* –ò–∫–æ–Ω–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ */
.status-icon {
  display: inline-block;
  width: 24px;
  height: 24px;
  vertical-align: baseline;
  font-size: 20px;
  font-weight: bold;
}
</style>
</head>

<body>
<!-- ===== FIXED PLAYER SECTION ===== -->
<div id="player-section">
  <div id="current-track" class="msg compact-mode">
    <div class="content">
      <div class="nick"></div>
      <div class="text">‚Äî –ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç ‚Äî</div>
      <div class="player-section">
        <div class="time-info">
          <span class="current-time">0:00</span>
          <span class="total-time">0:00</span>
        </div>
        <div class="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="remaining-time" id="remaining-time"></div>
      </div>
    </div>
  </div>
  
  <div id="queue-section">
    <!-- Queue items will be inserted here -->
  </div>
</div>

<!-- ===== CHAT SECTION ===== -->
<div id="log">
  <!-- Chat messages will be inserted here -->
</div>

<div id="player" style="width:1px;height:1px;opacity:0;"></div>
<script src="https://www.youtube.com/iframe_api"></script>

<script>
const logEl = document.getElementById('log');
const playerSectionEl = document.getElementById('player-section');
const currentTrackEl = document.getElementById('current-track');
const queueSectionEl = document.getElementById('queue-section');
const progressBarEl = document.getElementById('progress-bar');
const currentTimeEl = currentTrackEl.querySelector('.current-time');
const totalTimeEl = currentTrackEl.querySelector('.total-time');
const remainingTimeEl = document.getElementById('remaining-time');
const tiktokLikes = new Map();
const giftCombos = new Map(); // key -> timer
const QUEUE_UPDATE_INTERVAL = 500; // –û–±–Ω–æ–≤–ª—è—Ç—å –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 500ms
const MAX_CHAT_MESSAGES = 40;
const icons = {
  tiktok: `
    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12.5 2v12.2a3.3 3.3 0 1 1-2.4-3.2V8.3a6.4 6.4 0 1 0 5.3 6.3V7.6c1.2.8 2.6 1.3 4.1 1.3V6.2c-2.1 0-4.2-1.7-4.2-4.2h-2.8z"/>
    </svg>`,
  youtube: `
    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
      <path d="M23.5 6.5s-.2-1.7-.9-2.4c-.8-.9-1.7-.9-2.1-1C17.7 2.8 12 2.8 12 2.8h0s-5.7 0-8.5.3c-.4.1-1.3.1-2.1 1C.7 4.8.5 6.5.5 6.5S0 8.4 0 10.2v1.7c0 1.8.5 3.7.5 3.7s.2 1.7.9 2.4c.8.9 1.9.9 2.4 1 1.7.2 7.2.3 7.2.3s5.7 0 8.5-.3c.4-.1 1.3-.1 2.1-1 .7-.7.9-2.4.9-2.4s.5-1.8.5-3.7v-1.7c0-1.8-.5-3.7-.5-3.7zM9.5 14.6V7.8l6.2 3.4-6.2 3.4z"/>
    </svg>`,
  twitch: `
    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
      <path d="M4 2L2 6v14h5v2h3l2-2h4l4-4V2H4zm14 12l-2 2h-4l-2 2v-2H6V4h12v10z"/>
    </svg>`,
  telegram: `
    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
      <path d="M9.999 15.17 9.89 19c.44 0 .63-.19.86-.42l2.06-1.98 4.28 3.13c.78.43 1.34.2 1.54-.72l2.79-13.1h.01c.23-1.1-.4-1.54-1.15-1.27L2.48 9.34c-1.08.42-1.06 1.02-.2 1.29l4.6 1.44L17.7 5.6c.51-.33.98-.15.6.18"/>
    </svg>`,
    discord: `
      <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20.3 4.4A19.5 19.5 0 0 0 15.9 3l-.2.4a18.1 18.1 0 0 1 3.9 1.5 13.3 13.3 0 0 0-11.8 0A18.1 18.1 0 0 1 11.7 3l-.2-.4a19.5 19.5 0 0 0-4.4 1.4C3.9 8.1 3 12 3 15.9a19.9 19.9 0 0 0 5.1 2.6l.6-.8a12.3 12.3 0 0 1-2-1c.2-.2.4-.3.6-.5a13.4 13.4 0 0 0 12.6 0l.6.5a12.3 12.3 0 0 1-2 1l.6.8a19.9 19.9 0 0 0 5.1-2.6c0-3.9-.9-7.8-3.7-11.5z"/>
      </svg>`
};
// –ü–æ—Å–ª–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
const giftsStorage = {
  data: new Map(),
  saveToStorage() {
    const data = {};
    for (const [userId, userData] of this.data.entries()) {
      data[userId] = userData; // –ë–µ–∑ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ gifts —É–∂–µ –æ–±—ä–µ–∫—Ç
    }
    localStorage.setItem('stream_gifts_' + new Date().toDateString(), JSON.stringify(data));
  },
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage
  loadFromStorage() {
      const saved = localStorage.getItem('stream_gifts_' + new Date().toDateString());
      if (saved) {
        try {
          const data = JSON.parse(saved);
          for (const [userId, value] of Object.entries(data)) {
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ –Ω–æ–≤—É—é
            if (typeof value.gifts === 'number') {
              // –°—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: gifts –±—ã–ª —á–∏—Å–ª–æ–º
              this.data.set(userId, {
                nickname: value.nickname,
                gifts: { '–ü–æ–¥–∞—Ä–æ–∫': { amount: value.gifts, icon: null } },
                lastActive: value.lastActive || Date.now()
              });
            } else {
              // –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–ª–∏ —É–∂–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω–∞—è
              this.data.set(userId, value);
            }
          }
          console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è');
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤:', e);
          // –û—á–∏—â–∞–µ–º –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          this.data.clear();
        }
      }
    },
  // –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫
  addGift(userId, nickname, giftName, amount = 1, giftIcon = null) {
    if (!this.data.has(userId)) {
        this.data.set(userId, {
            nickname,
            gifts: {}, // giftName -> {amount, icon}
            lastActive: Date.now()
        });
    }
    
    const userData = this.data.get(userId);
    userData.nickname = nickname;
    userData.lastActive = Date.now();
    
    if (!userData.gifts[giftName]) {
        userData.gifts[giftName] = {
            amount: 0,
            icon: giftIcon // üëà –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∫–æ–Ω–∫—É
        };
    }
    
    userData.gifts[giftName].amount += amount;
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –µ—Å–ª–∏ –µ—ë –Ω–µ –±—ã–ª–æ
    if (giftIcon && !userData.gifts[giftName].icon) {
        userData.gifts[giftName].icon = giftIcon;
    }
    
    this.saveToStorage();
    return this.getUserTotal(userId);
  },
  // –ü–æ–ª—É—á–∏—Ç—å –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∞—Ä–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  getUserTotal(userId) {
      if (!this.data.has(userId)) return 0;
      const userData = this.data.get(userId);
  
      console.log(`getUserTotal –¥–ª—è ${userId}:`, userData); // –æ—Ç–ª–∞–¥–∫–∞
  
      // –ï—Å–ª–∏ gifts - —ç—Ç–æ —á–∏—Å–ª–æ
      if (typeof userData.gifts === 'number') {
        return userData.gifts;
      }
  
      // –ï—Å–ª–∏ gifts - —ç—Ç–æ –æ–±—ä–µ–∫—Ç
      if (userData.gifts && typeof userData.gifts === 'object') {
        let total = 0;
    
        // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ–¥–∞—Ä–∫–∏
        for (const [giftName, giftData] of Object.entries(userData.gifts)) {
          if (typeof giftData === 'number') {
            total += giftData;
          } else if (giftData && typeof giftData === 'object') {
            total += Number(giftData.amount) || 0;
          }
        }
    
        console.log(`–í—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π total: ${total}`); // –æ—Ç–ª–∞–¥–∫–∞
        return total;
      }
  
      return 0;
    },
  // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–¥–∞—Ä–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  getUserGifts(userId) {
    if (!this.data.has(userId)) return [];
    const userGifts = this.data.get(userId).gifts;
    return Object.entries(userGifts).map(([name, data]) => ({ 
        name, 
        amount: data.amount,
        icon: data.icon // üëà –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∫–æ–Ω–∫—É
    }));
  },
  // –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ø –¥–æ–Ω–∞—Ç–µ—Ä–æ–≤
  getTopDonaters(limit = 10) {
      const sorted = Array.from(this.data.entries())
        .map(([userId, data]) => {
          let total = 0;
      
          // –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∞—Ä–∫–æ–≤
          if (typeof data.gifts === 'number') {
            total = data.gifts;
          } else if (data.gifts && typeof data.gifts === 'object') {
            total = Object.values(data.gifts)
              .reduce((sum, giftData) => {
                if (typeof giftData === 'number') return sum + giftData;
                if (giftData && typeof giftData === 'object') return sum + (giftData.amount || 0);
                return sum;
              }, 0);
          }
      
          return {
            userId,
            nickname: data.nickname,
            total: total,
            gifts: (typeof data.gifts === 'object') 
              ? Object.entries(data.gifts).map(([name, giftData]) => ({ 
                  name, 
                  amount: (typeof giftData === 'number') ? giftData : (giftData?.amount || 0),
                  icon: (giftData && typeof giftData === 'object') ? giftData.icon : null
                }))
              : [{ name: '–ü–æ–¥–∞—Ä–æ–∫', amount: total, icon: null }]
          };
        })
        .sort((a, b) => b.total - a.total)
        .slice(0, limit);
      return sorted;
    },
  // –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)
  cleanupOld() {
      const now = Date.now();
      const DAY_MS = 24 * 60 * 60 * 1000;
      for (const [userId, data] of this.data.entries()) {
        if (now - data.lastActive > DAY_MS) {
          this.data.delete(userId);
        }
      }
      this.saveToStorage();
    },
  migrateOldData() {
      const keys = Object.keys(localStorage).filter(key => key.startsWith('stream_gifts_'));
      keys.forEach(key => {
        try {
          const oldData = JSON.parse(localStorage.getItem(key));
          const migrated = {};
      
          for (const [userId, value] of Object.entries(oldData)) {
            if (typeof value === 'number') {
              // –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è: –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∞—Ä–∫–æ–≤
              migrated[userId] = {
                nickname: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                gifts: { '–ü–æ–¥–∞—Ä–æ–∫': { amount: value, icon: null } },
                lastActive: Date.now()
              };
            } else if (value && typeof value === 'object') {
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É gifts
              if (typeof value.gifts === 'number') {
                // gifts - —ç—Ç–æ —á–∏—Å–ª–æ, –Ω—É–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å
                migrated[userId] = {
                  nickname: value.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                  gifts: { '–ü–æ–¥–∞—Ä–æ–∫': { amount: value.gifts, icon: null } },
                  lastActive: value.lastActive || Date.now()
                };
              } else {
                // –£–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
                migrated[userId] = value;
              }
            }
          }
      
          localStorage.setItem(key, JSON.stringify(migrated));
          console.log(`–ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ ${key}`);
        } catch (e) {
          console.error(`–û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ ${key}:`, e);
        }
      });
    },
};
let songQueueDisplay = {
  current: null,
  list: []
};
let player;
let progressInterval;
let currentVideoDuration = 0;
let ws;
let wsReconnectTimeout;
let lastQueueUpdate = 0;
let currentVideoId = null;

giftsStorage.loadFromStorage();
giftsStorage.migrateOldData();

function getGiftMap(el) {
  if (!el._gifts) el._gifts = new Map();
  return el._gifts;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function updateProgress() {
  if (!player || !player.getCurrentTime || !player.getDuration) return;

  try {
    const currentTime = player.getCurrentTime();
    const duration = player.getDuration() || currentVideoDuration;

    if (!duration || duration < 2) return;

    const percent = Math.min(100, (currentTime / duration) * 100);
    progressBarEl.style.width = `${percent}%`;

    currentTimeEl.textContent = formatTime(currentTime);
    totalTimeEl.textContent = formatTime(duration);

    const remaining = Math.max(0, duration - currentTime);
    remainingTimeEl.textContent = `‚àí${formatTime(remaining)}`;
    remainingTimeEl.classList.toggle('low-time', remaining < 10);
  } catch (err) {
    console.log('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', err);
  }
}

// –ù–∞—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function startProgressUpdate() {
  if (progressInterval) return;
  progressInterval = setInterval(updateProgress, 1000);
}

// –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function stopProgressUpdate(resetUI = true) {
  clearInterval(progressInterval);
  progressInterval = null;
  if (!resetUI) return;
  progressBarEl.style.width = '0%';
  currentTimeEl.textContent = '0:00';
  totalTimeEl.textContent = '0:00';
  remainingTimeEl.textContent = '‚Äî';
  remainingTimeEl.classList.remove('low-time');
}

function updateCurrentTrack() {
    const textElement = currentTrackEl.querySelector('.text');
    const playerSection = currentTrackEl.querySelector('.player-section');
    
    if(songQueueDisplay.current) {
        // –í–∫–ª—é—á–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        currentTrackEl.classList.remove('compact-mode');
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å –∞–≤—Ç–æ—Ä–æ–º –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º
        textElement.innerHTML = `${songQueueDisplay.current.title}`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫ —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º
        let requesterElement = currentTrackEl.querySelector('.requester');
        if (!requesterElement) {
            const requesterDiv = document.createElement('div');
            requesterDiv.className = 'requester';
            currentTrackEl.querySelector('.content').appendChild(requesterDiv);
            requesterElement = requesterDiv;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∑–∞–∫–∞–∑—á–∏–∫–∞
        const requester = songQueueDisplay.current.requester || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        requesterElement.innerHTML = `–ó–∞–∫–∞–∑—á–∏–∫: ${requester}`;
        requesterElement.style.display = 'block';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–µ—Ä
        playerSection.style.display = 'block';
    } else {
        // –í–∫–ª—é—á–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º
        currentTrackEl.classList.add('compact-mode');
        
        // –ü—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—É—Å—Ç–æ–º –ø–ª–µ–π–ª–∏—Å—Ç–µ
        textElement.innerHTML = '‚Äî –ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç ‚Äî';
        
        // –£–±–∏—Ä–∞–µ–º –±–ª–æ–∫ –∑–∞–∫–∞–∑—á–∏–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
        const requesterElement = currentTrackEl.querySelector('.requester');
        if (requesterElement) {
            requesterElement.style.display = 'none';
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–ª–µ–µ—Ä
        playerSection.style.display = 'none';
        stopProgressUpdate();
    }
}

// —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏
function displayQueue() {
  const now = Date.now();
  if (now - lastQueueUpdate < QUEUE_UPDATE_INTERVAL) {
    return;
  }
  lastQueueUpdate = now;
    // –ö—ç—à–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    const queueCache = JSON.stringify(songQueueDisplay.list.slice(0, 3));
    if (queueSectionEl.dataset.cache === queueCache) return;
    
    queueSectionEl.dataset.cache = queueCache;
    queueSectionEl.innerHTML = '';

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç—Ä–µ–∫–∏
    if (songQueueDisplay.list.length === 0) return;

    const displayQueue = songQueueDisplay.list.slice(0, 3);

    displayQueue.forEach((t, i) => {
        const el = document.createElement('div');
        el.className = 'msg queue-item';
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–∏–∫ –∑–∞–∫–∞–∑—á–∏–∫–∞
        const requester = t.requester ? `üßê ${t.requester}` : '';
        const durationText = t.duration
        ? `‚è± ${formatTime(t.duration)}`
        : '‚è± --:--';
        el.innerHTML = `
          <div class="content">
            <div class="nick" style="display: flex; justify-content: space-between; align-items: center;">
              <span>‚è≠ ${i + 1} ${requester}</span>
              <span style="font-size: 16px; opacity: 0.7;">
                ${durationText}
              </span>
            </div>
            <div class="text" style="font-size: 18px; margin-top: 2px;">
              ${t.title}
            </div>
          </div>
        `;
        queueSectionEl.appendChild(el);
    });

    // –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –±–æ–ª—å—à–µ 3, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "+N –µ—â—ë"
    if (songQueueDisplay.list.length > 3) {
        const more = document.createElement('div');
        more.className = 'msg queue-item';
        more.innerHTML = `
            <div class="content">
                <div class="nick">‚Ä¶</div>
                <div class="text">+${songQueueDisplay.list.length - 3} –µ—â—ë...</div>
            </div>
        `;
        queueSectionEl.appendChild(more);
    }
}

function updateNicknameEverywhere(userId, newNick) {
  document
    .querySelectorAll(`.nick[data-user-id="${userId}"]`)
    .forEach(el => {
      el.textContent = newNick;
    });
}

function scrollChatToBottom() {
  // –ñ–¥–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ü–∏–∫–ª–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
  requestAnimationFrame(() => {
      logEl.scrollTop = logEl.scrollHeight;
    });
}

// –í —Ñ—É–Ω–∫—Ü–∏–∏ logMessage –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É messageId –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function logMessage(platform, userId, nickname, text, isError = false, extraClass = '', time = '', messageId = null) {
  const DISABLE_ANIMATIONS_THRESHOLD = 30;
  if (logEl.children.length > DISABLE_ANIMATIONS_THRESHOLD) {
    document.documentElement.style.setProperty('--blur', 'none');
  }
  const isSystem = nickname === 'System' || platform === 'WS';
  const el = document.createElement('div');
  el.className = `msg ${platform} ${isError ? 'error' : ''} ${isSystem ? 'system' : ''} ${extraClass}`;
  el.dataset.userId = userId;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º messageId –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  if (messageId) {
    el.dataset.messageId = messageId;
  }

  el.innerHTML = `
  ${icons[platform] || ''}
  <div class="content">
    <div class="nick" data-user-id="${userId}">
      ${time ? `<span class="time">[${time}]</span>` : ''}
      ${nickname}
    </div>
    <div class="text">${text}</div>
  </div>
`;

  logEl.appendChild(el);

  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ
  if (logEl.children.length > MAX_CHAT_MESSAGES) {
    const toRemove = logEl.children.length - MAX_CHAT_MESSAGES;
    for (let i = 0; i < toRemove; i++) {
      if (logEl.firstChild) {
        logEl.removeChild(logEl.firstChild);
      }
    }
  }

  // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –∫ –Ω–æ–≤–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
  scrollChatToBottom();
  
  return el; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
}

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
function updateMessage(messageId, newText, extraClass = '', status = null) {
  // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ data-message-id
  const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
  
  if (!messageEl) {
    console.warn('–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:', messageId);
    return;
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã - —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
  if (extraClass) {
    messageEl.classList.remove('moderation-pending', 'moderation-approved', 'moderation-rejected');
    messageEl.classList.add(extraClass);
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
  const textEl = messageEl.querySelector('.text');
  if (textEl) {
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É —Å—Ç–∞—Ç—É—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    if (status === 'approved') {
      textEl.innerHTML = `<span class="status-icon" style="color: #00FF00;">‚úÖ</span> ${newText}`;
    } else if (status === 'rejected') {
      textEl.innerHTML = `<span class="status-icon" style="color: #FF0000;">‚ùå</span> ${newText}`;
    } else {
      textEl.textContent = newText;
    }
  }
  
  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
  messageEl.style.animation = 'none';
  setTimeout(() => {
    messageEl.offsetHeight; // trigger reflow
    messageEl.style.animation = null;
  }, 10);
}

function play(videoId) {
  if (videoId === currentVideoId) return;
  currentVideoId = videoId;
  if (!videoId || videoId.trim() === '') {
    console.warn('–ü—É—Å—Ç–æ–π videoId');
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–æ—Ç–æ–≤ –ª–∏ API
  if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
    console.error('YouTube API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    setTimeout(() => play(videoId), 1000); // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
    return;
  }

  if (!player) {
    player = new YT.Player('player', {
      height: '0',
      width: '0',
      videoId,
      playerVars: { 
        autoplay: 1, 
        controls: 0,
        modestbranding: 1,
        rel: 0,
        showinfo: 0
      },
      events: {
        onReady: (event) => {
          event.target.unMute();
          event.target.playVideo();
          currentVideoDuration = event.target.getDuration();
          updateProgress();
        },
        onStateChange: (event) => {
          switch (event.data) {
            case YT.PlayerState.ENDED:
              stopProgressUpdate(false);
              if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                  event: 'trackEnded'
                }));
              }
              break;

            case YT.PlayerState.PLAYING:
              currentVideoDuration = player.getDuration() || currentVideoDuration;
              startProgressUpdate();
              break;

            case YT.PlayerState.PAUSED:
            stopProgressUpdate(false);
            break;
          }
        },
        onError: (event) => {
          console.log('–û—à–∏–±–∫–∞ YouTube –ø–ª–µ–µ—Ä–∞:', event);
          stopProgressUpdate();
        }
      }
    });
  } else {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
    stopProgressUpdate(false);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ
    const tryPlay = () => {
      if (player && player.loadVideoById) {
        player.loadVideoById(videoId);
        player.unMute();
        player.playVideo();
        
        // –ñ–¥–µ–º, –ø–æ–∫–∞ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∏ –Ω–∞—á–Ω–µ—Ç –∏–≥—Ä–∞—Ç—å
        setTimeout(() => {
          currentVideoDuration = player.getDuration();
          updateProgress();
          startProgressUpdate();
        }, 500);
      } else {
        setTimeout(tryPlay, 200);
      }
    };
    tryPlay();
  }
}

/* ===== WebSocket ===== */
function connectWebSocket() {
  if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
    return;
  }
  
  ws = new WebSocket("ws://127.0.0.1:21214");
  
  ws.onopen = () => {
      console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
      clearTimeout(wsReconnectTimeout);
    };

    ws.onclose = () => {
      console.log('‚ö† WebSocket –æ—Ç–∫–ª—é—á–µ–Ω, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...');
      wsReconnectTimeout = setTimeout(connectWebSocket, 5000);
    };
  
  ws.onerror = (error) => {
    console.error('‚ùå –û—à–∏–±–∫–∞ WebSocket:', error);
  };
  
  // –æ—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ws.onmessage
  ws.onmessage = e => {
      try {
        const d = JSON.parse(e.data);

        // ===== CHAT HISTORY =====
        if (d.event === 'chatHistory' && Array.isArray(d.data)) {
            logEl.innerHTML = '';

            d.data.forEach(msg => {
                logMessage(
                    msg.platform,
                    msg.userId,
                    msg.nickname,
                    msg.text,
                    false,
                    msg.extraClass || '',
                    msg.time,
                    msg.messageId // ‚Üê –¥–æ–±–∞–≤–ª—è–µ–º messageId
                );
            });

            scrollChatToBottom();
            return;
        }

        // ===== –ù–û–í–û–ï –°–û–ë–´–¢–ò–ï: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è =====
        if (d.event === 'chat.update') {
            updateMessage(
                d.messageId,
                d.text,
                d.extraClass || '',
                d.status || null
            );
            return;
        }

        if(d.event === 'music') {
            songQueueDisplay.current = {
                videoId: d.data.videoId,
                author: d.data.author || 'Unknown',
                title: d.data.title || 'Unknown',
                requester: d.data.requester || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
            };
            updateCurrentTrack();    
            if (d.data.videoId && d.data.videoId.trim() !== '') {
                play(d.data.videoId);
            } else {
                stopProgressUpdate(false);
                if (player && player.stopVideo) {
                    player.stopVideo();
                }
            }
        }

        if(d.event === 'queue') {
            songQueueDisplay.list = d.data.list || [];
            updateCurrentTrack();
            displayQueue();
        }

        if(d.event === 'trackEnded') {
          stopProgressUpdate(false);
        }

        if(d.event === 'music_stop') {
          currentVideoId = null;
          songQueueDisplay.current = null;
          songQueueDisplay.list = [];
          updateCurrentTrack();
          displayQueue();
          stopProgressUpdate();
          if (player && player.stopVideo) {
            player.stopVideo();
          }
        }

        if (d.event === "music_pause") {
            if (player && typeof player.pauseVideo === 'function') {
                player.pauseVideo();
            }
        }

        if (d.event === "music_play") {
            if (player && typeof player.playVideo === 'function') {
                player.playVideo();
            }
        }

        if (d.event === 'like' && d.platform === 'tiktok') {
          const { userId, nickname, amount } = d.data;

          const prev = tiktokLikes.get(userId) || 0;
          const total = prev + amount;
          tiktokLikes.set(userId, total);

          const newNick = `[TikTok] ${nickname} ‚ù§Ô∏è√ó${total}`;
          updateNicknameEverywhere(userId, newNick);
        }

        if (d.event === 'chat') {
          logMessage(
            d.platform,
            d.data.userId,
            d.data.nickname,
            d.data.text,
            false,
            d.data.extraClass || '',   // ‚Üê –î–û–ë–ê–í–õ–ï–ù–û!
            d.data.time || '',         // ‚Üê –Ω–∞ —Å–ª—É—á–∞–π undefined
            d.data.messageId || null   // ‚Üê –î–û–ë–ê–í–õ–ï–ù–û!
          );
        }

        if (d.event === 'gift') {
            console.log('GIFT RECEIVED', d);
            const { userId, nickname, gift, amount = 1 } = d.data;
            const giftName = gift?.name || '–ü–æ–¥–∞—Ä–æ–∫';
            const giftIcon = gift?.icon || null;
    
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
            const totalDonated = giftsStorage.addGift(userId, nickname, giftName, amount, giftIcon);
            const giverId = 'giver_' + userId;
            let giver = document.getElementById(giverId);
    
            if (!giver) {
                giver = document.createElement('div');
                giver.className = 'msg gift-message';
                giver.id = giverId;

                const userGifts = giftsStorage.getUserGifts(userId);
                const totalDonated = giftsStorage.getUserTotal(userId);

                giver.innerHTML =
                    '<div class="content">' +
                      `<div class="nick">${nickname} <span class="total-count" style="margin-left:8px;color:#ffd700;font-weight:bold">(–≤—Å–µ–≥–æ: ${totalDonated})</span></div>` +
                      '<div class="gift-list"></div>' +
                    '</div>';

                logEl.appendChild(giver);

                if (userGifts.length > 0) {
                    const giftList = giver.querySelector('.gift-list');
                    userGifts.forEach(giftItem => {
                        const entry = {
                            amount: giftItem.amount,
                            el: document.createElement('div')
                        };
    
                        entry.el.className = 'gift restored-gift';
                        const iconHTML = giftItem.icon 
                            ? `<img src="${giftItem.icon}" alt="${giftItem.name}" />`
                            : 'üéÅ';
    
                        entry.el.innerHTML =
                            iconHTML +
                            `<span class="gift-name">${giftItem.name}</span>` +
                            ` √ó<span class="gift-count">${giftItem.amount}</span>`;
    
                        giftList.appendChild(entry.el);
                        getGiftMap(giver).set(giftItem.name, entry);
                    });
                }
            } else {
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                const totalSpan = giver.querySelector('.total-count');
                if (totalSpan) {
                    totalSpan.textContent = `(–≤—Å–µ–≥–æ: ${totalDonated})`;
                }
            }
            const giftList = giver.querySelector('.gift-list');
            const gifts = getGiftMap(giver);
            const giftKey = gift?.name || '–ü–æ–¥–∞—Ä–æ–∫';
            let entry = gifts.get(giftKey);
            if (!entry) {
                entry = {
                    amount: giftsStorage.data.get(userId).gifts[giftKey].amount,
                    el: document.createElement('div')
                };

                entry.el.className = 'gift';
                entry.el.innerHTML =
                    (gift?.icon
                        ? '<img src="' + gift.icon + '" />'
                        : 'üéÅ') +
                    '<span class="gift-name">' + giftKey + '</span>' +
                    ' √ó<span class="gift-count">' + amount + '</span>'; // ‚Üê —Å—Ä–∞–∑—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!

                giftList.appendChild(entry.el);
                gifts.set(giftKey, entry);
            } else {
                // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª, –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                entry.amount = giftsStorage.data.get(userId).gifts[giftKey].amount;
                entry.el.querySelector('.gift-count').textContent = entry.amount;
            }
            // üî• –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ
            entry.el.classList.remove('pulse');
            void entry.el.offsetWidth;
            entry.el.classList.add('pulse');

            // üåü –±–æ–ª—å—à–∏–µ –∫–æ–º–±–æ
            if (entry.amount >= 10) {
              entry.el.classList.add('big');
            }

            // ‚è± –∫–æ–º–±–æ-—Ç–∞–π–º–µ—Ä
            const comboKey = giverId + giftKey;

            // –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ç–∞–π–º–µ—Ä
            clearTimeout(giftCombos.get(comboKey));

            // –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä, –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—É–ª—å—Å –∏ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π
            giftCombos.set(comboKey, setTimeout(() => {
              // —É–±–∏—Ä–∞–µ–º –ø—É–ª—å—Å
              entry.el.classList.remove('pulse');

              // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–∏
              entry.el.classList.add('combo-done'); // CSS –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∑–æ–ª–æ—Ç–æ–π, —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –∏ —Ç.–¥.

              // –ù–ï —É–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏ –Ω–µ —á–∏—Å—Ç–∏–º Map
              giftCombos.delete(comboKey);
            }, 3000));

            // üîΩ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –∑—Ä–∏—Ç–µ–ª—è –≤–Ω–∏–∑ —á–∞—Ç–∞
            logEl.appendChild(giver);

            scrollChatToBottom();
        }

        if (d.event === 'share')
          logMessage(d.platform, d.data.userId, d.data.nickname, '–ü–æ–¥–µ–ª–∏–ª—Å—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–µ–π!', false, 'share');

        if (d.event === 'follow')
          logMessage(d.platform, d.data.userId, d.data.nickname, '–¢–µ–ø–µ—Ä—å –ø–æ–¥–ø–∏—Å—á–∏–∫', false, 'follow');
      } catch (err) {
          logMessage('system', 0, 'System', '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è', true);
          console.error(err, e.data);
        }
    };
}

// –ó–∞–º–µ–Ω–∏—Ç–µ —Å—Ç—Ä–æ–∫—É const ws = new WebSocket(...) –Ω–∞:
document.addEventListener('DOMContentLoaded', () => {
  updateCurrentTrack(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  connectWebSocket(); // ‚Üê –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è WS –Ω–∞–ø—Ä—è–º—É—é
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è YouTube API
window.onYouTubeIframeAPIReady = function() {
  console.log('YouTube API –≥–æ—Ç–æ–≤');
};

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', () => {
  stopProgressUpdate();
  if (player && player.destroy) {
    player.destroy();
  }
});
</script>

<audio id="gift-sound" src="gift-sound.mp3" preload="auto"></audio>
</body>
</html>