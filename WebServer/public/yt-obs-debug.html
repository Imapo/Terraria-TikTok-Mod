<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>OBS Chat Overlay</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

:root {
  --bg: rgba(20,20,20,0.9);
  --radius: 10px;
  --blur: blur(10px);
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  background: transparent;
  font-family: 'Inter', sans-serif;
  color: white;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ===== FIXED PLAYER SECTION ===== */
#player-section {
  flex-shrink: 0;
  width: 100%;
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(5px);
  padding: 0px 10px;
}

/* ===== CHAT SECTION ===== */
#log {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 10px;
  overflow-y: auto; /* –ò–∑–º–µ–Ω–µ–Ω–æ —Å hidden –Ω–∞ auto */
  overflow-x: hidden;
  margin-top: 0;
}

/* ===== Message card ===== */
.msg {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  background: var(--bg);
  backdrop-filter: var(--blur);
  padding: 6px 10px;
  animation: slideFade 0.35s ease-out forwards;
  opacity: 0;
  transform: translateY(6px);
}

@keyframes slideFade {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ===== Platform icons ===== */
.icon {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
  margin-top: 2px;
}

.tiktok .icon { color: #69C9D0; }
.youtube .icon { color: #FF4444; }
.twitch .icon  { color: #9146FF; }

.error {
  background: rgba(255,80,80,0.3);
  color: #ffb3b3;
}

/* ===== Text ===== */
.content {
  display: flex;
  flex-direction: column;
  gap: 2px;
  width: 100%;
}

.nick {
  font-weight: 600;
  font-size: 20px;
  opacity: 0.95;
}

.text {
  font-size: 20px;
  line-height: 1.3;
  opacity: 0.9;
}

.gift {
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.gift img {
  width: 24px;
  height: 24px;
  border-radius: 4px;
  object-fit: cover;
}

.gift-name {
  font-weight: 600;
  color: #ffd700;
}

/* ===== Current track ===== */
#current-track {
  border-left: 30px solid #FFD700; /* –∑–æ–ª–æ—Ç–æ–π –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞ */
  font-size: 20px;
  pointer-events: none; /* –Ω–µ–ª—å–∑—è –≤—ã–¥–µ–ª—è—Ç—å */
}
#current-track .nick {
  font-weight: 700;
  font-size: 22px;
  color: #fff;
}
#current-track .text {
  font-size: 20px;
  color: #fff;
}

/* ===== –ü–ª–µ–µ—Ä –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä ===== */
.player-section {
  margin-top: 8px;
  width: 100%;
  display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
}

.progress-container {
  width: 100%;
  height: 8px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 6px;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #FF5555, #FFD700);
  width: 0%;
  border-radius: 4px;
  transition: width 0.3s ease;
}

.time-info {
  display: flex;
  justify-content: space-between;
  font-size: 16px;
  color: #ddd;
  margin-bottom: 4px;
}

.current-time, .total-time {
  font-weight: 600;
}

.remaining-time {
  font-size: 16px;
  color: #ffd700;
  font-weight: 600;
  text-align: center;
  background: rgba(255, 215, 0, 0.1);
  padding: 2px 8px;
  border-radius: 4px;
  margin-top: 4px;
}

/* ===== Queue section ===== */
#queue-section {
  margin-top: 10px;
  width: 100%;
}

.queue-item {
  border-left: 3px solid #5599FF;
  border-bottom: 2px solid #222;
}

.queue-item .content {
  width: 100%;
}

.queue-item .nick {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 18px;
}

.queue-item .text {
  font-size: 18px;
  margin-top: 2px;
  opacity: 0.9;
}

/* ===== –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏ ===== */
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

.remaining-time.low-time {
  animation: pulse 1s infinite;
  background: rgba(255, 80, 80, 0.2);
  color: #ff8080;
}

/* –°—Ç–∏–ª—å –¥–ª—è –∑–∞–∫–∞–∑—á–∏–∫–∞ –≤ —Ç–µ–∫—É—â–µ–º —Ç—Ä–µ–∫–µ */
.requester {
  font-size: 18px;
  color: #69C9D0;
  margin-top: 4px;
  font-weight: 600;
  display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
}

/* –°—Ç–∏–ª—å –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
.compact-mode {
  min-height: auto;
  padding: 8px 10px;
}

.compact-mode .text {
  font-size: 20px;
  margin: 0;
}

/* ===== Scrollbar styling ===== */
#log::-webkit-scrollbar {
  width: 6px;
}

#log::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 3px;
}

#log::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.3);
  border-radius: 3px;
}

#log::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.5);
}
</style>
</head>

<body>
<!-- ===== FIXED PLAYER SECTION ===== -->
<div id="player-section">
  <div id="current-track" class="msg compact-mode">
    <div class="content">
      <div class="nick"></div>
      <div class="text">‚Äî –ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç ‚Äî</div>
      <div class="player-section">
        <div class="time-info">
          <span class="current-time">0:00</span>
          <span class="total-time">0:00</span>
        </div>
        <div class="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="remaining-time" id="remaining-time"></div>
      </div>
    </div>
  </div>
  
  <div id="queue-section">
    <!-- Queue items will be inserted here -->
  </div>
</div>

<!-- ===== CHAT SECTION ===== -->
<div id="log">
  <!-- Chat messages will be inserted here -->
</div>

<div id="player" style="width:1px;height:1px;opacity:0;"></div>
<script src="https://www.youtube.com/iframe_api"></script>

<script>
const logEl = document.getElementById('log');
const playerSectionEl = document.getElementById('player-section');
const currentTrackEl = document.getElementById('current-track');
const queueSectionEl = document.getElementById('queue-section');
const progressBarEl = document.getElementById('progress-bar');
const currentTimeEl = currentTrackEl.querySelector('.current-time');
const totalTimeEl = currentTrackEl.querySelector('.total-time');
const remainingTimeEl = document.getElementById('remaining-time');
const tiktokLikes = new Map();
const icons = {
  tiktok: `
    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12.5 2v12.2a3.3 3.3 0 1 1-2.4-3.2V8.3a6.4 6.4 0 1 0 5.3 6.3V7.6c1.2.8 2.6 1.3 4.1 1.3V6.2c-2.1 0-4.2-1.7-4.2-4.2h-2.8z"/>
    </svg>`,
  youtube: `
    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
      <path d="M23.5 6.5s-.2-1.7-.9-2.4c-.8-.9-1.7-.9-2.1-1C17.7 2.8 12 2.8 12 2.8h0s-5.7 0-8.5.3c-.4.1-1.3.1-2.1 1C.7 4.8.5 6.5.5 6.5S0 8.4 0 10.2v1.7c0 1.8.5 3.7.5 3.7s.2 1.7.9 2.4c.8.9 1.9.9 2.4 1 1.7.2 7.2.3 7.2.3s5.7 0 8.5-.3c.4-.1 1.3-.1 2.1-1 .7-.7.9-2.4.9-2.4s.5-1.8.5-3.7v-1.7c0-1.8-.5-3.7-.5-3.7zM9.5 14.6V7.8l6.2 3.4-6.2 3.4z"/>
    </svg>`,
  twitch: `
    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
      <path d="M4 2L2 6v14h5v2h3l2-2h4l4-4V2H4zm14 12l-2 2h-4l-2 2v-2H6V4h12v10z"/>
    </svg>`
};
let songQueueDisplay = {
  current: null,
  list: []
};
let player;
let progressInterval;
let currentVideoDuration = 0;

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function updateProgress() {
  if (!player || !player.getCurrentTime) return;
  
  try {
    const currentTime = player.getCurrentTime();
    const duration = player.getDuration() || currentVideoDuration;
    
    if (duration > 0) {
      const progressPercent = (currentTime / duration) * 100;
      progressBarEl.style.width = `${progressPercent}%`;
      
      currentTimeEl.textContent = formatTime(currentTime);
      totalTimeEl.textContent = formatTime(duration);
      
      // –û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è
      const remaining = duration - currentTime;
      remainingTimeEl.textContent = `‚è±Ô∏è –û—Å—Ç–∞–ª–æ—Å—å: ${formatTime(remaining)}`;
      
      // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω—å—à–µ 30 —Å–µ–∫—É–Ω–¥ - –¥–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
      if (remaining < 30) {
        remainingTimeEl.classList.add('low-time');
      } else {
        remainingTimeEl.classList.remove('low-time');
      }
    }
  } catch (err) {
    console.log('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', err);
  }
}

// –ù–∞—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function startProgressUpdate() {
  clearInterval(progressInterval);
  progressInterval = setInterval(updateProgress, 1000);
}

// –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function stopProgressUpdate() {
  clearInterval(progressInterval);
  progressBarEl.style.width = '0%';
  currentTimeEl.textContent = '0:00';
  totalTimeEl.textContent = '0:00';
  remainingTimeEl.textContent = '‚Äî';
  remainingTimeEl.classList.remove('low-time');
}

function updateCurrentTrack() {
    const textElement = currentTrackEl.querySelector('.text');
    const playerSection = currentTrackEl.querySelector('.player-section');
    
    if(songQueueDisplay.current) {
        // –í–∫–ª—é—á–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        currentTrackEl.classList.remove('compact-mode');
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å –∞–≤—Ç–æ—Ä–æ–º –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º
        textElement.innerHTML = `${songQueueDisplay.current.title}`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫ —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º
        let requesterElement = currentTrackEl.querySelector('.requester');
        if (!requesterElement) {
            const requesterDiv = document.createElement('div');
            requesterDiv.className = 'requester';
            currentTrackEl.querySelector('.content').appendChild(requesterDiv);
            requesterElement = requesterDiv;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∑–∞–∫–∞–∑—á–∏–∫–∞
        const requester = songQueueDisplay.current.requester || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        requesterElement.innerHTML = `–ó–∞–∫–∞–∑—á–∏–∫: ${requester}`;
        requesterElement.style.display = 'block';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–µ—Ä
        playerSection.style.display = 'block';
    } else {
        // –í–∫–ª—é—á–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º
        currentTrackEl.classList.add('compact-mode');
        
        // –ü—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—É—Å—Ç–æ–º –ø–ª–µ–π–ª–∏—Å—Ç–µ
        textElement.innerHTML = '‚Äî –ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç ‚Äî';
        
        // –£–±–∏—Ä–∞–µ–º –±–ª–æ–∫ –∑–∞–∫–∞–∑—á–∏–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
        const requesterElement = currentTrackEl.querySelector('.requester');
        if (requesterElement) {
            requesterElement.style.display = 'none';
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–ª–µ–µ—Ä
        playerSection.style.display = 'none';
        stopProgressUpdate();
    }
}

// —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏
function displayQueue() {
    // –æ—á–∏—â–∞–µ–º –æ—á–µ—Ä–µ–¥—å
    queueSectionEl.innerHTML = '';

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç—Ä–µ–∫–∏
    if (songQueueDisplay.list.length === 0) return;

    const displayQueue = songQueueDisplay.list.slice(0, 3);

    displayQueue.forEach((t, i) => {
        const el = document.createElement('div');
        el.className = 'msg queue-item';
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–∏–∫ –∑–∞–∫–∞–∑—á–∏–∫–∞
        const requester = t.requester ? `üßê ${t.requester}` : '';
        const durationText = t.duration
        ? `‚è± ${formatTime(t.duration)}`
        : '‚è± --:--';
        el.innerHTML = `
          <div class="content">
            <div class="nick" style="display: flex; justify-content: space-between; align-items: center;">
              <span>‚è≠ ${i + 1} ${requester}</span>
              <span style="font-size: 16px; opacity: 0.7;">
                ${durationText}
              </span>
            </div>
            <div class="text" style="font-size: 18px; margin-top: 2px;">
              ${t.title}
            </div>
          </div>
        `;
        queueSectionEl.appendChild(el);
    });

    // –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –±–æ–ª—å—à–µ 3, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "+N –µ—â—ë"
    if (songQueueDisplay.list.length > 3) {
        const more = document.createElement('div');
        more.className = 'msg queue-item';
        more.innerHTML = `
            <div class="content">
                <div class="nick">‚Ä¶</div>
                <div class="text">+${songQueueDisplay.list.length - 3} –µ—â—ë...</div>
            </div>
        `;
        queueSectionEl.appendChild(more);
    }
}

function updateNicknameEverywhere(userId, newNick) {
  document
    .querySelectorAll(`.nick[data-user-id="${userId}"]`)
    .forEach(el => {
      el.textContent = newNick;
    });
}

function scrollChatToBottom() {
  // –ñ–¥–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ü–∏–∫–ª–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
  setTimeout(() => {
    logEl.scrollTop = logEl.scrollHeight;
  }, 50);
}

// –í —Ñ—É–Ω–∫—Ü–∏–∏ logMessage –¥–æ–±–∞–≤—å—Ç–µ –≤—ã–∑–æ–≤ –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª–∞
function logMessage(platform, userId, nickname, text, isError = false, extraClass = '') {
  const el = document.createElement('div');
  el.className = `msg ${platform} ${isError ? 'error' : ''} ${extraClass}`;
  el.dataset.userId = userId;

  el.innerHTML = `
    ${icons[platform] || ''}
    <div class="content">
      <div class="nick" data-user-id="${userId}">${nickname}</div>
      <div class="text">${text}</div>
    </div>
  `;

  logEl.appendChild(el);

  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ
  while (logEl.children.length > 50) {
    logEl.removeChild(logEl.firstChild);
  }

  // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –∫ –Ω–æ–≤–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
  scrollChatToBottom();
}

/* ===== WebSocket ===== */
const ws = new WebSocket("ws://127.0.0.1:21214");

function play(videoId) {
  if (!player) {
    player = new YT.Player('player', {
      height: '0',
      width: '0',
      videoId,
      playerVars: { 
        autoplay: 1, 
        controls: 0,
        modestbranding: 1,
        rel: 0,
        showinfo: 0
      },
      events: {
        onReady: (event) => {
          event.target.unMute();
          event.target.playVideo();
          currentVideoDuration = event.target.getDuration();
          updateProgress();
          startProgressUpdate();
        },
        onStateChange: (event) => {
          if (event.data === YT.PlayerState.ENDED) {
            stopProgressUpdate();
            ws.send(JSON.stringify({ event: 'trackEnded' }));
          } else if (event.data === YT.PlayerState.PLAYING) {
            currentVideoDuration = player.getDuration();
            startProgressUpdate();
          } else if (event.data === YT.PlayerState.PAUSED) {
            clearInterval(progressInterval);
          }
        },
        onError: (event) => {
          console.log('–û—à–∏–±–∫–∞ YouTube –ø–ª–µ–µ—Ä–∞:', event);
          stopProgressUpdate();
        }
      }
    });
  } else {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
    stopProgressUpdate();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ
    const tryPlay = () => {
      if (player && player.loadVideoById) {
        player.loadVideoById(videoId);
        player.unMute();
        player.playVideo();
        
        // –ñ–¥–µ–º, –ø–æ–∫–∞ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∏ –Ω–∞—á–Ω–µ—Ç –∏–≥—Ä–∞—Ç—å
        setTimeout(() => {
          currentVideoDuration = player.getDuration();
          updateProgress();
          startProgressUpdate();
        }, 500);
      } else {
        setTimeout(tryPlay, 200);
      }
    };
    tryPlay();
  }
}

ws.onopen = () =>
  logMessage('WS', 0, 'System', 'WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω');

ws.onclose = () =>
  logMessage('WS', 0, 'System', 'WebSocket –æ—Ç–∫–ª—é—á—ë–Ω', true);

ws.onerror = () =>
  logMessage('WS', 0, 'System', '–û—à–∏–±–∫–∞ WebSocket', true);

ws.onmessage = e => {
  try {
    const d = JSON.parse(e.data);

    if(d.event === 'music') {
        songQueueDisplay.current = {
            videoId: d.data.videoId,
            author: d.data.author || 'Unknown',
            title: d.data.title || 'Unknown',
            requester: d.data.requester || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
        };
        updateCurrentTrack();
        displayQueue();
    
        if (d.data.videoId && d.data.videoId.trim() !== '') {
            play(d.data.videoId);
        } else {
            stopProgressUpdate();
            if (player && player.stopVideo) {
                player.stopVideo();
            }
        }
    }

    if(d.event === 'queue') {
        songQueueDisplay.list = d.data.list || [];
        updateCurrentTrack();
        displayQueue();
    }

    if(d.event === 'trackEnded') {
      if(songQueueDisplay.list.length > 0) {
        songQueueDisplay.current = songQueueDisplay.list.shift();
      } else {
        songQueueDisplay.current = null;
      }
      updateCurrentTrack();
      displayQueue();
      stopProgressUpdate();
    }

    if(d.event === 'music_stop') {
      songQueueDisplay.current = null;
      songQueueDisplay.list = [];
      updateCurrentTrack();
      displayQueue();
      stopProgressUpdate();
      if (player && player.stopVideo) {
        player.stopVideo();
      }
    }

    if (d.event === "music_pause") {
        if (player && typeof player.pauseVideo === 'function') {
            player.pauseVideo();
        }
    }

    if (d.event === "music_play") {
        if (player && typeof player.playVideo === 'function') {
            player.playVideo();
        }
    }

    if (d.event === 'like' && d.platform === 'tiktok') {
      const { userId, nickname, amount } = d.data;

      const prev = tiktokLikes.get(userId) || 0;
      const total = prev + amount;
      tiktokLikes.set(userId, total);

      const newNick = `[TikTok] ${nickname} ‚ù§Ô∏è√ó${total}`;
      updateNicknameEverywhere(userId, newNick);
    }

    if (d.event === 'chat')
      logMessage(d.platform, d.data.userId, d.data.nickname, d.data.text);

    if (d.event === 'gift') {
      console.log('GIFT RECEIVED', d);
      const g = d.data.gift || {};
      const amount = d.data.amount ?? 1;
      const giftHtml =
        '<div class="gift">' +
        (g.icon ? '<img src="' + g.icon + '" />' : 'üéÅ') +
        '<span class="gift-name">' + (g.name || '–ü–æ–¥–∞—Ä–æ–∫') + '</span>' +
        ' √ó' + amount +
        '</div>';
        logMessage(d.platform, d.data.userId, d.data.nickname, giftHtml, false, 'gift');
    }

    if (d.event === 'share')
      logMessage(d.platform, d.data.userId, d.data.nickname, '–ü–æ–¥–µ–ª–∏–ª—Å—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–µ–π!', false, 'share');

    if (d.event === 'follow')
      logMessage(d.platform, d.data.userId, d.data.nickname, '–¢–µ–ø–µ—Ä—å –ø–æ–¥–ø–∏—Å—á–∏–∫', false, 'follow');
  } catch (err) {
      logMessage('system', 0, 'System', '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è', true);
      console.error(err, e.data);
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è YouTube API
window.onYouTubeIframeAPIReady = function() {
  console.log('YouTube API –≥–æ—Ç–æ–≤');
};

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', () => {
  stopProgressUpdate();
  if (player && player.destroy) {
    player.destroy();
  }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', () => {
  updateCurrentTrack();
});
</script>

<audio id="gift-sound" src="gift-sound.mp3" preload="auto"></audio>
</body>
</html>